<body bgcolor="black" style="margin:0">    
<canvas id="canvas"></canvas>
</body>
<script>

const canvas = document.getElementById('canvas');
W= window.innerWidth; H= window.innerHeight;
canvas.width=W; canvas.height=H;
const ctx = canvas.getContext('2d');

const earth=[[2400,2200,1900,1300,2000,2000,3000,2000,1000,0,-500,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [2500,2400,2000,1500,2200,3400,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [3000,3200,3400,3100,2400,4000,3000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [400,300,1000,1000,3000,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [300,100,1000,1000,2400,4000,8000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [200,300,1000,2000,3000,4000,9000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,100,1000,1000,2400,4000,5000,2000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000],
			 [0,0,1000,2000,3000,4000,5000,4000,1000,0,0,-1000,-2000,-3000,-5000,-7000,-8000,-9000,-10000,-11000]
			];

function draw_cell(x,y,r,c){
	ctx.beginPath();
	ctx.fillStyle=c;
	ctx.moveTo(x-r,y);
	ctx.lineTo(x-r/2,y-r*Math.sqrt(3)/2);
	ctx.lineTo(x+r/2,y-r*Math.sqrt(3)/2);
	ctx.lineTo(x+r,y);
	ctx.lineTo(x+r/2,y+r*Math.sqrt(3)/2);
	ctx.lineTo(x-r/2,y+r*Math.sqrt(3)/2);
	ctx.lineTo(x-r,y);
	ctx.fill();
};

function Tile(xx, yy, x,y,r,c){
	this.xx=xx;
	this.yy=yy;
	this.x=x;
	this.y=y;
	this.c=c;
	this.r=r;
	this.terrain ={
			value: earth[yy][xx],
			color: [150,140,120]
		};
	this.water={
			value: (xx==6 && yy==5) ? 3000000: 0, //Math.random(),
			color: [30,120,255]
		};
};
Tile.prototype={
	draw : function(){
		draw_cell(this.x,this.y,this.r,"rgba("+this.terrain.color[0]
			+","+this.terrain.color[1]
			+","+this.terrain.color[2]+","+(this.terrain.value+11000)/20000+")");

		draw_cell(this.x,this.y,this.r,"rgba("+this.water.color[0]
			+","+this.water.color[1]
			+","+this.water.color[2]+","+(this.water.value/6000)+")");
	},
};

function surrounding(xx,yy){
	var r=[];
	if (yy-1>0) r.push(world.layers[0].map[yy-2][xx]);
	if (yy+2<world.h) r.push(world.layers[0].map[yy+2][xx]);

	if (yy>0) r.push(world.layers[0].map[yy-1][xx]);
	if (xx>0 && yy>0) r.push(world.layers[0].map[yy-1][xx-1]);

	if (yy+1<world.h) r.push(world.layers[0].map[yy+1][xx]);
	if (xx>0 && yy+1<world.h) r.push(world.layers[0].map[yy+1][xx-1]);
	return r;
};

function Layer(w,h,r,c){
	this.w=w;
	this.h=h;
	this.r=r;
	this.c=c;
	this.map=[];
	this.air= {
		temp: 40,
		co2: 0.05,
		n2: 0.70,
		o2: 0.25,
		water: 0
	}

	for (var i=0; i<this.h; i++){
		this.map[i]=[];
		for (var j=0; j<this.w; j++){
			this.map[i][j]=new Tile(j, i, j*this.r*3 + (i % 2)*this.r*1.5, 
			i*this.r*Math.sqrt(3)/2, this.r, this.c);
		};
	};
};
Layer.prototype={
	draw: function(){
		for (var i=0; i<this.h; i++)
			for (var j=0; j<this.w; j++){
				this.map[i][j].draw();
		}	
	},
	update: function(){
		for (var i=0; i<this.h; i++)
			for (var j=0; j<this.w; j++){
			
				//water spreading
				var ss=surrounding(j,i);
				for (var s in ss){
					var sl=(ss[s].terrain.value+ss[s].water.value),
						tl=(this.map[i][j].terrain.value+this.map[i][j].water.value),
						gap=sl-tl;
					if (gap>0 && ss[s].water.value>0) {
					 	if (ss[s].water.value>gap/2){
							ss[s].water.value-=gap/2;
							this.map[i][j].water.value+=gap/2;
						} else {
							this.map[i][j].water.value+=ss[s].water.value;
							ss[s].water.value=0;						
						};
					};
					if (gap<0 && this.map[i][j].water.value>0) {
					 	if (this.map[i][j].water.value>(-gap/2)){
							this.map[i][j].water.value+=gap/2;
							ss[s].water.value-=gap/2;
						} else {
							ss[s].water.value+=this.map[i][j].water.value;						
							this.map[i][j].water.value=0;
						};
					};
				};
				
				//vaporing
// 				this.map[i][j].ground[1].value=this.map[i][j].ground[1].value* (1-this.air.temp/10000);
// 				this.air.water+=this.map[i][j].ground[1].value* this.air.temp/10000;
		};		
		
// 		if (this.air.water>60)
// 		for (var i=0; i<this.h; i++)
// 			for (var j=0; j<this.w; j++){
// 					this.map[i][j].ground[1].value+=this.air.water/this.w/this.h;
// 					this.air.water-=this.air.water/this.w/this.h;									
// 				};	

	},
};

function World(){
	this.w=20;
	this.h=60;
	this.tile_r=20;
	this.layers=[];
	this.layers.push(new Layer(this.w, this.h, this.tile_r, "rgba(255,255,255,0.2)"));
};
World.prototype={
	draw: function(){
		ctx.clearRect(0,0,W,H);
		for (var i=0; i<this.layers.length; i++) this.layers[i].draw();
	},
	update: function(){
		for (var i=0; i<this.layers.length; i++) this.layers[i].update();		
	}
};

function anim(){
	world.update();
	world.draw();		
	requestAnimationFrame(anim);
};

var world=new World();
anim();
</script>